!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.keyboardLink=e()}(this,function(){"use strict";function t(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function e(t,e,n,i){return new(n||(n=Promise))(function(o,r){function s(t){try{a(i.next(t))}catch(t){r(t)}}function u(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(s,u)}a((i=i.apply(t,e||[])).next())})}function n(t,e){function n(t){return function(e){return i([t,e])}}function i(n){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,r&&(s=2&n[0]?r.return:n[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,n[1])).done)return s;switch(r=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,r=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(s=a.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){a=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){a.label=n[1];break}if(6===n[0]&&a.label<s[1]){a.label=s[1],s=n;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(n);break}s[2]&&a.ops.pop(),a.trys.pop();continue}n=e.call(t,a)}catch(t){n=[6,t],r=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var o,r,s,u,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return u={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(u[Symbol.iterator]=function(){return this}),u}var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},o=function(){function t(t){var i=t.host,o=t.port,r=this;this.content=function(){r.isConnect||(r.ws=new WebSocket(r.url),r.ws.onopen=function(){console.log("keyboard-link is connect"),r.isConnect=!0},r.ws.onmessage=function(t){r.receive(JSON.parse(t.data))},r.ws.onerror=function(){r.isConnect=!1},r.ws.onclose=function(){r.isConnect=!1,r.content()})},this.send=function(t){if(!r.ws||!r.isConnect)return{success:!1,msg:"ws not connect",data:null};var e=r.utilsGenerateId(),n=JSON.stringify({id:e,method:t.method,data:t.data});return r.ws.send(n),{success:!0,msg:null,data:null}},this.sendReceive=function(t){return e(r,void 0,void 0,function(){var e,i,o=this;return n(this,function(n){return this.ws&&this.isConnect?(e=this.utilsGenerateId(),i=JSON.stringify({id:e,method:t.method,data:t.data}),this.ws.send(i),[2,new Promise(function(t){o.messageCallbacks[e]=t})]):[2,{success:!1,msg:"ws not connect",data:null}]})})},this.receive=function(t){var e=t.id,n=t.callMethod,i=t.payload;e&&r.messageCallbacks[e]&&(r.messageCallbacks[e]({success:!0,msg:"OK",data:i}),delete r.messageCallbacks[e]),!e&&n&&r[n]&&r[n](t.payload)},this.utilsGenerateId=function(){return Date.now().toString()+"-"+Math.random().toString(36).substring(2)},this.ws=null,this.isConnect=!1,this.url=i+":"+o,this.messageCallbacks=new Map,this.content()}return t}(),r=function(i){function o(){var t=null!==i&&i.apply(this,arguments)||this;return t.sendActiveInputValue=function(e){t.send({method:"activeInputValue",data:e})},t.testSend=function(e){var n=e.method,i=e.data;t.send({method:n,data:i})},t.testSendReceive=function(i){return e(t,void 0,void 0,function(){return n(this,function(t){switch(t.label){case 0:return[4,this.sendReceive({method:"test",data:i})];case 1:return[2,t.sent()]}})})},t.handleTest=function(t){console.log("服务端调用测试自定义方法",t)},t}return t(o,i),o}(o);return function(){function t(t){var i=t.host,o=t.port,s=t.useTimer,u=void 0!==s&&s,a=this;if(this.init=function(){return e(a,void 0,void 0,function(){return n(this,function(t){return document.addEventListener("focusin",this.focusInChange),document.addEventListener("focusout",this.focusOutChange),[2]})})},this.inputChange=function(t){return a.ws&&a.nowElement&&(a.nowElement instanceof HTMLInputElement||a.nowElement instanceof HTMLTextAreaElement)?t.target.value!==a.timerCache?(a.timerCache=t.target.value,void a.ws.sendActiveInputValue(t.target.value||"")):void 0:void a.handleClearTimer()},this.sendTimerValue=function(){return a.ws&&a.nowElement&&(a.nowElement instanceof HTMLInputElement||a.nowElement instanceof HTMLTextAreaElement)?a.nowElement.value!==a.timerCache?(a.timerCache=a.nowElement.value,void a.ws.sendActiveInputValue(a.nowElement.value||"")):void 0:void a.handleClearTimer()},this.handleClearTimer=function(){a.timer&&(clearInterval(a.timer),a.timer=null,a.timerCache=null)},this.focusInChange=function(){return e(a,void 0,void 0,function(){var t;return n(this,function(e){return t=document.activeElement,this.ws&&this.ws.sendActiveInputValue(t.value||""),this.nowElement=t,this.nowElement.addEventListener("input",this.inputChange),this.useTimer&&(this.handleClearTimer(),this.timer=setInterval(this.sendTimerValue,200)),[2]})})},this.focusOutChange=function(){return e(a,void 0,void 0,function(){return n(this,function(t){return this.handleClearTimer(),this.nowElement&&this.nowElement.removeEventListener("input",this.inputChange),[2]})})},!i||!o)throw new Error("host or port is null");this.host=i,this.port=o,this.ws=new r({host:this.host,port:this.port}),this.useTimer=u,this.timer=null,this.timerCache=null,this.init()}return t}()});
