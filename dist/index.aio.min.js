!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.keyboardLink=t()}(this,function(){"use strict";function e(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function t(e,t,n,i){return new(n||(n=Promise))(function(r,s){function o(e){try{u(i.next(e))}catch(e){s(e)}}function a(e){try{u(i.throw(e))}catch(e){s(e)}}function u(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(o,a)}u((i=i.apply(e,t||[])).next())})}function n(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,s&&(o=2&n[0]?s.return:n[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,n[1])).done)return o;switch(s=0,o&&(n=[2&n[0],o.value]),n[0]){case 0:case 1:o=n;break;case 4:return u.label++,{value:n[1],done:!1};case 5:u.label++,s=n[1],n=[0];continue;case 7:n=u.ops.pop(),u.trys.pop();continue;default:if(o=u.trys,!(o=o.length>0&&o[o.length-1])&&(6===n[0]||2===n[0])){u=0;continue}if(3===n[0]&&(!o||n[1]>o[0]&&n[1]<o[3])){u.label=n[1];break}if(6===n[0]&&u.label<o[1]){u.label=o[1],o=n;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(n);break}o[2]&&u.ops.pop(),u.trys.pop();continue}n=t.call(e,u)}catch(e){n=[6,e],s=0}finally{r=o=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,s,o,a,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a}var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},r=function(){function e(e){var i=e.host,r=e.port,s=this;this.content=function(){s.isConnect||(s.ws=new WebSocket(s.url),s.ws.onopen=function(){console.log("keyboard-link is connect"),s.isConnect=!0},s.ws.onmessage=function(e){s.receive(JSON.parse(e.data))},s.ws.onerror=function(){s.isConnect=!1},s.ws.onclose=function(){s.isConnect=!1,s.content()})},this.send=function(e){if(!s.ws||!s.isConnect)return{success:!1,msg:"ws not connect",data:null};var t=s.utilsGenerateId(),n=JSON.stringify({id:t,method:e.method,data:e.data});return s.ws.send(n),{success:!0,msg:null,data:null}},this.sendReceive=function(e){return t(s,void 0,void 0,function(){var t,i,r=this;return n(this,function(n){return this.ws&&this.isConnect?(t=this.utilsGenerateId(),i=JSON.stringify({id:t,method:e.method,data:e.data}),this.ws.send(i),[2,new Promise(function(e){r.messageCallbacks[t]=e})]):[2,{success:!1,msg:"ws not connect",data:null}]})})},this.receive=function(e){var t=e.id,n=e.callMethod,i=e.payload;t&&s.messageCallbacks[t]&&(s.messageCallbacks[t]({success:!0,msg:"OK",data:i}),delete s.messageCallbacks[t]),!t&&n&&s[n]&&s[n](e.payload)},this.utilsGenerateId=function(){return Date.now().toString()+"-"+Math.random().toString(36).substring(2)},this.utilsRemoveLeadingNewlines=function(e){return e.replace(/^\n+/,"")},this.utilsRemoveTrailingNewlines=function(e){return e.replace(/\n+$/,"")},this.utilsPreconditioningSendData=function(e){var t=e.str,n=e.isRemoveHeaderNewlinesCharacter,i=e.isRemoveTailNewlinesCharacter,r="";return"number"!=typeof t&&"string"!=typeof t||(r=t),n&&(r=s.utilsRemoveLeadingNewlines(r)),i&&(r=s.utilsRemoveTrailingNewlines(r)),r},this.ws=null,this.isConnect=!1,this.url=i+":"+r,this.messageCallbacks=new Map,this.content()}return e}(),s=function(i){function r(){var e=null!==i&&i.apply(this,arguments)||this;return e.sendActiveInputValue=function(t){e.send({method:"activeInputValue",data:t})},e.testSend=function(t){var n=t.method,i=t.data;e.send({method:n,data:i})},e.testSendReceive=function(i){return t(e,void 0,void 0,function(){return n(this,function(e){switch(e.label){case 0:return[4,this.sendReceive({method:"test",data:i})];case 1:return[2,e.sent()]}})})},e.handleTest=function(e){console.log("服务端调用测试自定义方法",e)},e}return e(r,i),r}(r);return function(){function e(e){var i=e.host,r=e.port,o=e.useTimer,a=void 0!==o&&o,u=e.isRemoveHeaderNewlinesCharacter,c=void 0!==u&&u,l=e.isRemoveTailNewlinesCharacter,h=void 0!==l&&l,d=this;if(this.init=function(){return t(d,void 0,void 0,function(){return n(this,function(e){return document.addEventListener("focusin",this.focusInChange),document.addEventListener("focusout",this.focusOutChange),[2]})})},this.inputChange=function(e){if(!d.ws||!d.nowElement||!(d.nowElement instanceof HTMLInputElement||d.nowElement instanceof HTMLTextAreaElement))return void d.handleClearTimer();if(e.target.value!==d.timerCache){d.timerCache=e.target.value;var t=d.ws.utilsPreconditioningSendData({str:e.target.value,isRemoveHeaderNewlinesCharacter:d.isRemoveHeaderNewlinesCharacter,isRemoveTailNewlinesCharacter:d.isRemoveTailNewlinesCharacter});return void d.ws.sendActiveInputValue(t)}},this.sendTimerValue=function(){if(!d.ws||!d.nowElement||!(d.nowElement instanceof HTMLInputElement||d.nowElement instanceof HTMLTextAreaElement))return void d.handleClearTimer();if(d.nowElement.value!==d.timerCache){d.timerCache=d.nowElement.value;var e=d.ws.utilsPreconditioningSendData({str:d.nowElement.value,isRemoveHeaderNewlinesCharacter:d.isRemoveHeaderNewlinesCharacter,isRemoveTailNewlinesCharacter:d.isRemoveTailNewlinesCharacter});return void d.ws.sendActiveInputValue(e)}},this.handleClearTimer=function(){d.timer&&(clearInterval(d.timer),d.timer=null,d.timerCache=null)},this.focusInChange=function(){return t(d,void 0,void 0,function(){var e,t;return n(this,function(n){return e=document.activeElement,this.ws&&(t=this.ws.utilsPreconditioningSendData({str:e.value,isRemoveHeaderNewlinesCharacter:this.isRemoveHeaderNewlinesCharacter,isRemoveTailNewlinesCharacter:this.isRemoveTailNewlinesCharacter}),this.ws.sendActiveInputValue(t)),this.nowElement=e,this.nowElement.addEventListener("input",this.inputChange),this.useTimer&&(this.handleClearTimer(),this.timer=setInterval(this.sendTimerValue,200)),[2]})})},this.focusOutChange=function(){return t(d,void 0,void 0,function(){return n(this,function(e){return this.handleClearTimer(),this.nowElement&&this.nowElement.removeEventListener("input",this.inputChange),[2]})})},!i||!r)throw new Error("host or port is null");this.host=i,this.port=r,this.ws=new s({host:this.host,port:this.port}),this.useTimer=a,this.timer=null,this.timerCache=null,this.isRemoveHeaderNewlinesCharacter=c,this.isRemoveTailNewlinesCharacter=h,this.init()}return e}()});
